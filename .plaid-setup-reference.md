# Plaid Integration Quick Reference

Generated by `pnpm setup:plaid` on ${new Date().toISOString().split('T')[0]}

## Your Plaid Configuration

**Environment:** See `apps/api/.env.local` for your actual values

- `PLAID_ENV` - sandbox/development/production
- `PLAID_CLIENT_ID` - Your Plaid client ID
- `PLAID_SECRET` - Your Plaid secret key
- `PLAID_ACCESS_TOKEN_ENCRYPTION_KEY` - Generated encryption key for access tokens
- `PLAID_PRODUCTS` - Enabled products (transactions, auth, balance, etc.)
- `PLAID_COUNTRY_CODES` - Supported country codes
- `PLAID_REDIRECT_URI` - OAuth redirect URI
- `PLAID_WEBHOOK_URL` - Webhook endpoint (optional)

## Testing in Sandbox

### Sandbox Test Credentials

**Good User (Success Flow):**
- Username: `user_good`
- Password: `pass_good`
- Institution: Any from the list

**Bad User (Error Flow):**
- Username: `user_bad`
- Password: `pass_good`
- Institution: Any from the list

### Sandbox Institutions

The sandbox includes test versions of real banks:
- Chase
- Bank of America
- Wells Fargo
- Citi
- Capital One
- And many more...

## Common Plaid Workflows

### 1. Create Link Token (API)

```typescript
import { plaidClient } from './plaid-client';

const response = await plaidClient.linkTokenCreate({
  user: { client_user_id: userId },
  client_name: 'SuperBasic Finance',
  products: ['transactions'],
  country_codes: ['US'],
  language: 'en',
  redirect_uri: process.env.PLAID_REDIRECT_URI,
});

const linkToken = response.data.link_token;
```

### 2. Exchange Public Token (API)

```typescript
const response = await plaidClient.itemPublicTokenExchange({
  public_token: publicToken,
});

const accessToken = response.data.access_token;
const itemId = response.data.item_id;

// IMPORTANT: Encrypt access token before storing!
```

### 3. Fetch Accounts

```typescript
const response = await plaidClient.accountsGet({
  access_token: decryptedAccessToken,
});

const accounts = response.data.accounts;
```

### 4. Fetch Transactions

```typescript
const response = await plaidClient.transactionsGet({
  access_token: decryptedAccessToken,
  start_date: '2024-01-01',
  end_date: '2024-12-31',
});

const transactions = response.data.transactions;
```

### 5. Sync Transactions (Recommended)

```typescript
let cursor = lastSyncCursor || null;
let hasMore = true;

while (hasMore) {
  const response = await plaidClient.transactionsSync({
    access_token: decryptedAccessToken,
    cursor: cursor,
  });

  // Process response.data.added
  // Process response.data.modified
  // Process response.data.removed

  cursor = response.data.next_cursor;
  hasMore = response.data.has_more;
}

// Save cursor for next sync
```

## Security Best Practices

### Access Token Encryption

**Always encrypt Plaid access tokens before storing in database!**

```typescript
import crypto from 'crypto';

const ALGORITHM = 'aes-256-gcm';
const KEY = Buffer.from(process.env.PLAID_ACCESS_TOKEN_ENCRYPTION_KEY!, 'base64');

function encrypt(text: string): string {
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipheriv(ALGORITHM, KEY, iv);
  
  let encrypted = cipher.update(text, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  
  const authTag = cipher.getAuthTag();
  
  // Format: iv:authTag:encrypted
  return `${iv.toString('hex')}:${authTag.toString('hex')}:${encrypted}`;
}

function decrypt(encrypted: string): string {
  const [ivHex, authTagHex, encryptedText] = encrypted.split(':');
  
  const iv = Buffer.from(ivHex, 'hex');
  const authTag = Buffer.from(authTagHex, 'hex');
  const decipher = crypto.createDecipheriv(ALGORITHM, KEY, iv);
  
  decipher.setAuthTag(authTag);
  
  let decrypted = decipher.update(encryptedText, 'hex', 'utf8');
  decrypted += decipher.final('utf8');
  
  return decrypted;
}
```

### Environment Variable Security

- ✅ Never commit `.env.local` files
- ✅ Use different credentials for sandbox/development/production
- ✅ Rotate credentials if compromised
- ✅ Use environment-specific encryption keys
- ✅ Keep encryption key backed up securely

## Plaid Dashboard

### Important Links

- **Main Dashboard:** https://dashboard.plaid.com
- **API Keys:** https://dashboard.plaid.com/team/keys
- **Webhooks:** https://dashboard.plaid.com/team/api
- **OAuth Settings:** https://dashboard.plaid.com/team/api
- **Documentation:** https://plaid.com/docs/

### Common Tasks

**View Recent API Calls:**
1. Go to Dashboard → Logs
2. Filter by status code or endpoint
3. Inspect request/response payloads

**Test Webhooks:**
1. Go to Team Settings → API → Webhooks
2. Click "Send Test Webhook"
3. Check your endpoint logs

**Rotate Credentials:**
1. Go to Team Settings → Keys
2. Click "Rotate" next to the secret
3. Update your .env.local file
4. Deploy updated configuration

## Error Handling

### Common Errors

**INVALID_CREDENTIALS**
- User entered wrong username/password
- Handle: Show error, allow retry

**ITEM_LOGIN_REQUIRED**
- User needs to re-authenticate with bank
- Handle: Use Link in update mode

**INSTITUTION_DOWN**
- Bank's API is temporarily unavailable
- Handle: Retry later, show status message

**RATE_LIMIT_EXCEEDED**
- Too many API requests
- Handle: Implement exponential backoff

### Error Response Format

```typescript
{
  error_type: 'ITEM_ERROR',
  error_code: 'ITEM_LOGIN_REQUIRED',
  error_message: 'the login details of this item have changed...',
  display_message: 'Please reconnect your account',
  request_id: '7abc123def456'
}
```

## Webhooks

### Webhook Types

**INITIAL_UPDATE**
- Sent after successful Link connection
- Contains latest transactions

**HISTORICAL_UPDATE**
- Sent after historical transactions are available
- Can take several minutes

**DEFAULT_UPDATE**
- Sent when new transactions are available
- Check regularly (daily sync recommended)

**TRANSACTIONS_REMOVED**
- Sent when transactions are deleted by bank
- Update your database accordingly

### Webhook Handler Example

```typescript
app.post('/v1/webhooks/plaid', async (c) => {
  const body = await c.req.json();
  
  switch (body.webhook_type) {
    case 'TRANSACTIONS':
      switch (body.webhook_code) {
        case 'INITIAL_UPDATE':
        case 'HISTORICAL_UPDATE':
        case 'DEFAULT_UPDATE':
          // Queue sync job
          await queueTransactionSync(body.item_id);
          break;
        
        case 'TRANSACTIONS_REMOVED':
          // Remove transactions
          await removeTransactions(body.removed_transactions);
          break;
      }
      break;
    
    case 'ITEM':
      switch (body.webhook_code) {
        case 'ERROR':
          // Handle item error
          await handleItemError(body.item_id, body.error);
          break;
      }
      break;
  }
  
  return c.json({ received: true });
});
```

## Development Tips

### Use Sandbox Liberally

- Sandbox is completely free
- No rate limits in sandbox
- Reset test data anytime
- Test all error scenarios

### Transaction Date Ranges

- Sandbox returns 2 years of test data
- Production returns up to 24 months (varies by institution)
- Use `transactions/sync` endpoint instead of `transactions/get`

### Performance

- Cache account data (changes rarely)
- Use cursors for incremental syncs
- Implement background job for long syncs
- Handle webhooks for push updates

### Testing OAuth Banks

Some sandbox institutions require OAuth flow:
1. Set `PLAID_REDIRECT_URI` in your .env
2. Add URI to Plaid dashboard
3. Handle OAuth return in your app
4. Test with "Platypus OAuth Bank" in sandbox

## Phase 4 Implementation Checklist

See `.kiro/specs/plaid-bank-connections/tasks.md` for detailed tasks.

**Core Implementation:**
- [ ] Database schema (connections, accounts, transactions)
- [ ] Plaid client wrapper with encryption
- [ ] Link token creation endpoint
- [ ] Public token exchange endpoint
- [ ] Account sync service
- [ ] Transaction sync service
- [ ] Webhook handler
- [ ] Connection status management

**Web UI:**
- [ ] Plaid Link integration
- [ ] Connection list page
- [ ] Account details page
- [ ] Reconnection flow for errors
- [ ] Loading states and error handling

**Testing:**
- [ ] Unit tests for services
- [ ] Integration tests for API endpoints
- [ ] E2E tests with sandbox
- [ ] Error scenario tests
- [ ] Webhook handler tests

## Support

**Plaid Support:**
- Email: support@plaid.com
- Dashboard: Use chat widget in bottom-right
- Docs: https://plaid.com/docs/

**Project Documentation:**
- Architecture: `.kiro/steering/agents.md`
- Database Schema: `.kiro/steering/database-schema.md`
- Phase 4 Specs: `.kiro/specs/plaid-bank-connections/`

---

**Generated by SuperBasic Finance setup wizard**  
**For internal development use only**
