generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// CORE AUTH MODELS
// =============================================================================

model User {
  id                 String    @id @default(uuid()) @db.Uuid
  primaryEmail       String    @map("primary_email")
  emailVerified      Boolean   @default(false) @map("email_verified")
  displayName        String?   @map("display_name")
  picture            String?
  userState          UserState @default(active) @map("user_state")
  defaultWorkspaceId String?   @map("default_workspace_id") @db.Uuid
  lastLoginAt        DateTime? @map("last_login_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  deletedAt          DateTime? @map("deleted_at")

  identities           UserIdentity[]
  authSessions         AuthSession[]
  refreshTokens        RefreshToken[]
  apiKeys              ApiKey[]
  authorizationCodes   OAuthAuthorizationCode[]
  securityEvents       SecurityEvent[]
  workspaceMemberships WorkspaceMember[]
  profile              Profile?
  password             UserPassword?

  @@index([userState])
  @@index([deletedAt])
  @@index([lastLoginAt])
  // Note: Email uniqueness for active users is enforced via partial unique index in migration SQL
  // (CREATE UNIQUE INDEX "users_active_email_unique" ON "users"("primary_email") WHERE "deleted_at" IS NULL)
  @@map("users")
}

model UserPassword {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @unique @map("user_id") @db.Uuid
  passwordHash String   @map("password_hash")
  changedAt    DateTime @default(now()) @map("changed_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_passwords")
}

model UserIdentity {
  id                      String   @id @default(uuid()) @db.Uuid
  userId                  String   @map("user_id") @db.Uuid
  provider                IdentityProvider
  providerSubject         String   @map("provider_subject")
  emailAtProvider         String?  @map("email_at_provider")
  emailVerifiedAtProvider Boolean? @map("email_verified_at_provider")
  rawProfile              Json?    @map("raw_profile")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  linkedAt                DateTime @default(now()) @map("linked_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerSubject])
  @@index([userId])
  @@map("user_identities")
}

model VerificationToken {
  id         String                @id @default(uuid()) @db.Uuid
  identifier String
  tokenId    String                @map("token_id")
  hashEnvelope Json                @map("hash_envelope")
  type       VerificationTokenType
  expiresAt  DateTime              @map("expires_at")
  consumedAt DateTime?             @map("consumed_at")
  createdAt  DateTime              @default(now()) @map("created_at")
  updatedAt  DateTime              @updatedAt @map("updated_at")

  @@index([identifier])
  @@index([expiresAt])
  @@index([consumedAt])
  @@map("verification_tokens")
}

model AuthSession {
  id             String    @id @default(uuid()) @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  expiresAt      DateTime  @map("expires_at")
  lastActivityAt DateTime? @map("last_activity_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  mfaLevel       MfaLevel  @default(none) @map("mfa_level")
  mfaCompletedAt DateTime? @map("mfa_completed_at")
  clientInfo     Json?     @map("client_info")
  ipAddress      String?   @map("ip_address")
  revokedAt      DateTime? @map("revoked_at")

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshTokens RefreshToken[]

  @@index([userId])
  @@index([revokedAt])
  @@index([expiresAt])
  @@map("auth_sessions")
}

model RefreshToken {
  id            String    @id
  userId        String    @map("user_id") @db.Uuid
  sessionId     String    @map("session_id") @db.Uuid
  familyId      String    @default(uuid()) @map("family_id") @db.Uuid
  hashEnvelope  Json      @map("hash_envelope")
  last4         String?
  issuedAt      DateTime  @default(now()) @map("issued_at")
  lastUsedAt    DateTime? @map("last_used_at")
  expiresAt     DateTime  @map("expires_at")
  revokedAt     DateTime? @map("revoked_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  createdByIp   String?   @map("created_by_ip")
  lastUsedIp    String?   @map("last_used_ip")
  userAgent     String?   @map("user_agent")
  rotatedFromId String?   @map("rotated_from_id")

  session     AuthSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  rotatedFrom RefreshToken? @relation("RefreshTokenRotation", fields: [rotatedFromId], references: [id])
  rotatedTo   RefreshToken[] @relation("RefreshTokenRotation")

  @@index([userId])
  @@index([sessionId])
  @@index([familyId])
  @@index([revokedAt])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model ApiKey {
  id           String   @id
  userId       String   @map("user_id") @db.Uuid
  workspaceId  String?  @map("workspace_id") @db.Uuid
  keyHash      Json     @map("key_hash")
  last4        String?
  scopes       String[] @default([])
  name         String?
  issuedAt     DateTime @default(now()) @map("issued_at")
  lastUsedAt   DateTime? @map("last_used_at")
  expiresAt    DateTime  @map("expires_at")
  revokedAt    DateTime? @map("revoked_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  createdByIp  String?   @map("created_by_ip")
  lastUsedIp   String?   @map("last_used_ip")
  userAgent    String?   @map("user_agent")
  metadata     Json?

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([workspaceId])
  @@index([revokedAt])
  @@index([expiresAt])
  @@map("api_keys")
}

// =============================================================================
// SERVICE IDENTITIES (NEW)
// =============================================================================

model ServiceIdentity {
  id                String      @id @default(uuid()) @db.Uuid
  name              String
  serviceType       ServiceType @default(internal)
  allowedWorkspaces Json?       @default("[]") @map("allowed_workspaces")
  clientId          String      @unique @map("client_id")
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")
  disabledAt        DateTime?   @map("disabled_at")

  client         OAuthClient @relation(fields: [clientId], references: [clientId])
  clientSecrets  ClientSecret[]
  securityEvents SecurityEvent[]

  @@index([serviceType])
  @@index([disabledAt])
  @@map("service_identities")
}

model ClientSecret {
  id                String    @id @default(uuid()) @db.Uuid
  serviceIdentityId String    @map("service_identity_id") @db.Uuid
  secretHash        Json      @map("secret_hash")
  last4             String?
  createdAt         DateTime  @default(now()) @map("created_at")
  expiresAt         DateTime? @map("expires_at")
  revokedAt         DateTime? @map("revoked_at")

  serviceIdentity ServiceIdentity @relation(fields: [serviceIdentityId], references: [id], onDelete: Cascade)

  @@index([serviceIdentityId])
  @@index([revokedAt])
  @@index([expiresAt])
  @@map("client_secrets")
}

// =============================================================================
// SECURITY & AUDIT (NEW)
// =============================================================================

model SecurityEvent {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String?  @map("user_id") @db.Uuid
  workspaceId String?  @map("workspace_id") @db.Uuid
  serviceId   String?  @map("service_id") @db.Uuid
  eventType   String   @map("event_type")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")

  user            User?            @relation(fields: [userId], references: [id])
  workspace       Workspace?       @relation(fields: [workspaceId], references: [id])
  serviceIdentity ServiceIdentity? @relation(fields: [serviceId], references: [id])

  @@index([userId])
  @@index([workspaceId])
  @@index([serviceId])
  @@index([eventType])
  @@index([createdAt])
  @@map("security_events")
}

// =============================================================================
// WORKSPACE & TENANCY
// =============================================================================

model Workspace {
  id            String        @id @default(uuid()) @db.Uuid
  ownerUserId   String?       @map("owner_user_id") @db.Uuid
  name          String
  slug          String        @unique
  workspaceType WorkspaceType @default(personal) @map("workspace_type")
  settings      Json?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  deletedAt     DateTime?     @map("deleted_at")

  members                              WorkspaceMember[]
  apiKeys                              ApiKey[]
  securityEvents                       SecurityEvent[]
  accountGroups                        AccountGroup[]
  budgetActuals                        BudgetActual[]
  budgetPlans                          BudgetPlan[]
  profileTransactionAccessCacheEntries ProfileTransactionAccessCache[]
  savedViews                           SavedView[]
  connectionAccessCacheEntries         UserConnectionAccessCache[]
  workspaceAllowedAccounts             WorkspaceAllowedAccount[]
  workspaceCategories                  WorkspaceCategory[]
  workspaceCategoryOverrides           WorkspaceCategoryOverride[]
  workspaceConnectionLinks             WorkspaceConnectionLink[]

  @@index([ownerUserId])
  @@index([workspaceType])
  @@index([deletedAt])
  @@map("workspaces")
}

model WorkspaceMember {
  id          String        @id @default(uuid()) @db.Uuid
  workspaceId String        @map("workspace_id") @db.Uuid
  userId      String        @map("user_id") @db.Uuid
  role        WorkspaceRole
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  invitedAt   DateTime?     @map("invited_at")
  acceptedAt  DateTime?     @map("accepted_at")
  revokedAt   DateTime?     @map("revoked_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId, revokedAt])
  @@index([userId])
  @@index([revokedAt])
  @@map("workspace_memberships")
}

// =============================================================================
// OAUTH 2.1 / OIDC
// =============================================================================

model OAuthClient {
  id                      String           @id @default(uuid()) @db.Uuid
  clientId                String           @unique @map("client_id")
  clientType              OAuthClientType  @map("client_type")
  name                    String
  redirectUris            String[]         @map("redirect_uris")
  allowedGrantTypes       OAuthGrantType[] @default([]) @map("allowed_grant_types")
  allowedScopes           String[]         @default([]) @map("allowed_scopes")
  tokenEndpointAuthMethod AuthMethod       @default(none) @map("token_endpoint_auth_method")
  createdAt               DateTime         @default(now()) @map("created_at")
  updatedAt               DateTime         @updatedAt @map("updated_at")
  disabledAt              DateTime?        @map("disabled_at")

  authorizationCodes OAuthAuthorizationCode[]
  serviceIdentity    ServiceIdentity?

  @@index([disabledAt])
  @@map("oauth_clients")
}

model OAuthAuthorizationCode {
  id                  String              @id @default(uuid()) @db.Uuid
  userId              String              @map("user_id") @db.Uuid
  clientId            String              @map("client_id")
  redirectUri         String              @map("redirect_uri")
  codeHash            Json                @map("code_hash")
  codeChallenge       String              @map("code_challenge")
  codeChallengeMethod PkceChallengeMethod @default(S256) @map("code_challenge_method")
  scopes              String[]            @default([])
  nonce               String?
  expiresAt           DateTime            @map("expires_at")
  consumedAt          DateTime?           @map("consumed_at")
  createdAt           DateTime            @default(now()) @map("created_at")

  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  client OAuthClient @relation(fields: [clientId], references: [clientId])

  @@index([clientId])
  @@index([expiresAt])
  @@index([consumedAt])
  @@map("oauth_authorization_codes")
}

// =============================================================================
// APPLICATION MODELS
// =============================================================================
// These models belong to the application domain, not auth.
// They reference Profile (application) rather than User (auth).
// =============================================================================

model Profile {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @unique @map("user_id") @db.Uuid
  timezone  String   @default("UTC")
  currency  String   @default("USD") @db.VarChar(3)
  settings  Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user                          User                            @relation(fields: [userId], references: [id], onDelete: Cascade)
  ownedBudgetPlans              BudgetPlan[]
  categories                    Category[]
  sponsorHistoryFrom            ConnectionSponsorHistory[]      @relation("ConnectionSponsorFrom")
  sponsorHistoryTo              ConnectionSponsorHistory[]      @relation("ConnectionSponsorTo")
  connections                   Connection[]
  profileCategoryOverrides      ProfileCategoryOverride[]
  transactionAccessCacheEntries ProfileTransactionAccessCache[]
  subscriptions                 Subscription[]
  syncAuditLogs                 SyncAuditLog[]                  @relation("SyncAuditInitiator")
  syncSessions                  SyncSession[]                   @relation("SyncInitiator")
  transactionsOverlays          TransactionOverlay[]
  connectionAccessCacheEntries  UserConnectionAccessCache[]
  viewLinks                     ViewLink[]                      @relation("ViewLinkCreator")
  viewShares                    ViewShare[]
  workspaceAllowedAccounts      WorkspaceAllowedAccount[]
  workspaceConnectionLinks      WorkspaceConnectionLink[]       @relation("WorkspaceConnectionGrantor")

  @@map("profiles")
}

model Subscription {
  id                   String   @id @default(uuid()) @db.Uuid
  profileId            String   @map("profile_id") @db.Uuid
  stripeCustomerId     String?  @map("stripe_customer_id")
  stripeSubscriptionId String?  @map("stripe_subscription_id")
  slotLimit            Int?     @map("slot_limit")
  status               String
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  profile              Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("subscriptions")
}

model SavedView {
  id                String                 @id @default(uuid()) @db.Uuid
  workspaceId       String                 @map("workspace_id") @db.Uuid
  name              String?
  isDefault         Boolean                @default(false) @map("is_default")
  createdAt         DateTime               @default(now()) @map("created_at")
  updatedAt         DateTime               @updatedAt @map("updated_at")
  deletedAt         DateTime?              @map("deleted_at")
  budgetPlans       BudgetPlan[]
  workspace         Workspace              @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  categoryGroups    ViewCategoryGroup[]
  categoryOverrides ViewCategoryOverride[]
  filters           ViewFilter[]
  groupBy           ViewGroupBy[]
  links             ViewLink[]
  ruleOverrides     ViewRuleOverride[]
  shares            ViewShare[]
  sorts             ViewSort[]

  @@map("saved_views")
}

model ViewFilter {
  id        String    @id @default(uuid()) @db.Uuid
  viewId    String    @map("view_id") @db.Uuid
  payload   Json
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  view      SavedView @relation(fields: [viewId], references: [id], onDelete: Cascade)

  @@map("view_filters")
}

model ViewSort {
  id        String    @id @default(uuid()) @db.Uuid
  viewId    String    @map("view_id") @db.Uuid
  payload   Json
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  view      SavedView @relation(fields: [viewId], references: [id], onDelete: Cascade)

  @@map("view_sorts")
}

model ViewGroupBy {
  id        String    @id @default(uuid()) @db.Uuid
  viewId    String    @map("view_id") @db.Uuid
  payload   Json
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  view      SavedView @relation(fields: [viewId], references: [id], onDelete: Cascade)

  @@map("view_group_by")
}

model ViewRuleOverride {
  id        String    @id @default(uuid()) @db.Uuid
  viewId    String    @map("view_id") @db.Uuid
  payload   Json
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  view      SavedView @relation(fields: [viewId], references: [id], onDelete: Cascade)

  @@map("view_rule_overrides")
}

model ViewCategoryGroup {
  id        String    @id @default(uuid()) @db.Uuid
  viewId    String    @map("view_id") @db.Uuid
  payload   Json
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  view      SavedView @relation(fields: [viewId], references: [id], onDelete: Cascade)

  @@map("view_category_groups")
}

model ViewCategoryOverride {
  id                        String             @id @default(uuid()) @db.Uuid
  viewId                    String             @map("view_id") @db.Uuid
  sourceCategoryId          String?            @map("source_category_id") @db.Uuid
  targetCategoryId          String?            @map("target_category_id") @db.Uuid
  workspaceSourceCategoryId String?            @map("workspace_source_category_id") @db.Uuid
  workspaceTargetCategoryId String?            @map("workspace_target_category_id") @db.Uuid
  createdAt                 DateTime           @default(now()) @map("created_at")
  updatedAt                 DateTime           @updatedAt @map("updated_at")
  deletedAt                 DateTime?          @map("deleted_at")
  sourceCategory            Category?          @relation("ViewOverrideSourceCategory", fields: [sourceCategoryId], references: [id])
  targetCategory            Category?          @relation("ViewOverrideTargetCategory", fields: [targetCategoryId], references: [id])
  view                      SavedView          @relation(fields: [viewId], references: [id], onDelete: Cascade)
  workspaceSourceCategory   WorkspaceCategory? @relation("ViewOverrideWorkspaceSource", fields: [workspaceSourceCategoryId], references: [id])
  workspaceTargetCategory   WorkspaceCategory? @relation("ViewOverrideWorkspaceTarget", fields: [workspaceTargetCategoryId], references: [id])

  @@map("view_category_overrides")
}

model ViewShare {
  id        String    @id @default(uuid()) @db.Uuid
  viewId    String    @map("view_id") @db.Uuid
  profileId String    @map("profile_id") @db.Uuid
  canEdit   Boolean   @map("can_edit")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  profile   Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  view      SavedView @relation(fields: [viewId], references: [id], onDelete: Cascade)

  @@index([viewId])
  @@index([profileId])
  @@map("view_shares")
}

model ViewLink {
  id                 String    @id @default(uuid()) @db.Uuid
  viewId             String    @map("view_id") @db.Uuid
  tokenId            String    @unique @map("token_id") @db.Uuid
  tokenHash          Json      @map("token_hash")
  passcodeHash       Json?     @map("passcode_hash")
  expiresAt          DateTime  @map("expires_at")
  createdByProfileId String    @map("created_by_profile_id") @db.Uuid
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  creator            Profile   @relation("ViewLinkCreator", fields: [createdByProfileId], references: [id], onDelete: Cascade)
  view               SavedView @relation(fields: [viewId], references: [id], onDelete: Cascade)

  @@index([viewId])
  @@index([expiresAt])
  @@map("view_links")
}

model AccountGroup {
  id          String                   @id @default(uuid()) @db.Uuid
  workspaceId String                   @map("workspace_id") @db.Uuid
  name        String?
  color       String?
  sort        Int?
  createdAt   DateTime                 @default(now()) @map("created_at")
  updatedAt   DateTime                 @updatedAt @map("updated_at")
  deletedAt   DateTime?                @map("deleted_at")
  memberships AccountGroupMembership[]
  workspace   Workspace                @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("account_groups")
}

model AccountGroupMembership {
  id        String       @id @default(uuid()) @db.Uuid
  groupId   String       @map("group_id") @db.Uuid
  accountId String       @map("account_id") @db.Uuid
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")
  account   BankAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  group     AccountGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([accountId])
  @@map("account_group_memberships")
}

model WorkspaceConnectionLink {
  id                 String     @id @default(uuid()) @db.Uuid
  workspaceId        String     @map("workspace_id") @db.Uuid
  connectionId       String     @map("connection_id") @db.Uuid
  grantedByProfileId String     @map("granted_by_profile_id") @db.Uuid
  accountScopeJson   Json?      @map("account_scope_json")
  expiresAt          DateTime?  @map("expires_at")
  revokedAt          DateTime?  @map("revoked_at")
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @updatedAt @map("updated_at")
  connection         Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  grantedBy          Profile    @relation("WorkspaceConnectionGrantor", fields: [grantedByProfileId], references: [id], onDelete: Cascade)
  workspace          Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([connectionId])
  @@map("workspace_connection_links")
}

model WorkspaceAllowedAccount {
  id                 String      @id @default(uuid()) @db.Uuid
  workspaceId        String      @map("workspace_id") @db.Uuid
  bankAccountId      String      @map("bank_account_id") @db.Uuid
  grantedByProfileId String      @map("granted_by_profile_id") @db.Uuid
  revokedAt          DateTime?   @map("revoked_at")
  createdAt          DateTime    @default(now()) @map("created_at")
  bankAccount        BankAccount @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  grantedBy          Profile     @relation(fields: [grantedByProfileId], references: [id])
  workspace          Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([bankAccountId])
  @@map("workspace_allowed_accounts")
}

model Category {
  id                             String                      @id @default(uuid()) @db.Uuid
  profileId                      String?                     @map("profile_id") @db.Uuid
  parentId                       String?                     @map("parent_id") @db.Uuid
  slug                           String
  name                           String
  sort                           Int?
  createdAt                      DateTime                    @default(now()) @map("created_at")
  updatedAt                      DateTime                    @updatedAt @map("updated_at")
  deletedAt                      DateTime?                   @map("deleted_at")
  budgetEnvelopes                BudgetEnvelope[]
  parent                         Category?                   @relation("CategoryParent", fields: [parentId], references: [id])
  children                       Category[]                  @relation("CategoryParent")
  profile                        Profile?                    @relation(fields: [profileId], references: [id])
  profileOverridesSource         ProfileCategoryOverride[]   @relation("ProfileOverrideSource")
  profileOverridesTarget         ProfileCategoryOverride[]   @relation("ProfileOverrideTarget")
  transactionOverlays            TransactionOverlay[]
  transactions                   Transaction[]               @relation("TransactionSystemCategory")
  viewOverridesSource            ViewCategoryOverride[]      @relation("ViewOverrideSourceCategory")
  viewOverridesTarget            ViewCategoryOverride[]      @relation("ViewOverrideTargetCategory")
  workspaceOverridesSystemSource WorkspaceCategoryOverride[] @relation("WorkspaceOverrideSystemSource")
  workspaceOverridesSystemTarget WorkspaceCategoryOverride[] @relation("WorkspaceOverrideSystemTarget")

  @@index([profileId])
  @@map("categories")
}

model ProfileCategoryOverride {
  id               String    @id @default(uuid()) @db.Uuid
  profileId        String    @map("profile_id") @db.Uuid
  sourceCategoryId String    @map("source_category_id") @db.Uuid
  targetCategoryId String?   @map("target_category_id") @db.Uuid
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  deletedAt        DateTime? @map("deleted_at")
  profile          Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  source           Category  @relation("ProfileOverrideSource", fields: [sourceCategoryId], references: [id], onDelete: Cascade)
  target           Category? @relation("ProfileOverrideTarget", fields: [targetCategoryId], references: [id])

  @@index([profileId])
  @@map("profile_category_overrides")
}

model WorkspaceCategory {
  id                  String                      @id @default(uuid()) @db.Uuid
  workspaceId         String                      @map("workspace_id") @db.Uuid
  parentId            String?                     @map("parent_id") @db.Uuid
  slug                String
  name                String
  sort                Int?
  color               String?
  createdAt           DateTime                    @default(now()) @map("created_at")
  updatedAt           DateTime                    @updatedAt @map("updated_at")
  deletedAt           DateTime?                   @map("deleted_at")
  budgetActuals       BudgetActual[]
  viewOverridesSource ViewCategoryOverride[]      @relation("ViewOverrideWorkspaceSource")
  viewOverridesTarget ViewCategoryOverride[]      @relation("ViewOverrideWorkspaceTarget")
  parent              WorkspaceCategory?          @relation("WorkspaceCategoryParent", fields: [parentId], references: [id])
  children            WorkspaceCategory[]         @relation("WorkspaceCategoryParent")
  workspace           Workspace                   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  overridesSource     WorkspaceCategoryOverride[] @relation("WorkspaceOverrideSource")
  overridesTarget     WorkspaceCategoryOverride[] @relation("WorkspaceOverrideTarget")

  @@index([workspaceId])
  @@map("workspace_categories")
}

model WorkspaceCategoryOverride {
  id                      String             @id @default(uuid()) @db.Uuid
  workspaceId             String             @map("workspace_id") @db.Uuid
  sourceCategoryId        String?            @map("source_category_id") @db.Uuid
  targetCategoryId        String?            @map("target_category_id") @db.Uuid
  systemSourceCategoryId  String?            @map("system_source_category_id") @db.Uuid
  systemTargetCategoryId  String?            @map("system_target_category_id") @db.Uuid
  createdAt               DateTime           @default(now()) @map("created_at")
  updatedAt               DateTime           @updatedAt @map("updated_at")
  deletedAt               DateTime?          @map("deleted_at")
  sourceWorkspaceCategory WorkspaceCategory? @relation("WorkspaceOverrideSource", fields: [sourceCategoryId], references: [id])
  systemSourceCategory    Category?          @relation("WorkspaceOverrideSystemSource", fields: [systemSourceCategoryId], references: [id])
  systemTargetCategory    Category?          @relation("WorkspaceOverrideSystemTarget", fields: [systemTargetCategoryId], references: [id])
  targetWorkspaceCategory WorkspaceCategory? @relation("WorkspaceOverrideTarget", fields: [targetCategoryId], references: [id])
  workspace               Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@map("workspace_category_overrides")
}

model Connection {
  id                                   String                          @id @default(uuid()) @db.Uuid
  ownerProfileId                       String                          @map("owner_profile_id") @db.Uuid
  provider                             String
  providerItemId                       String                          @map("provider_item_id")
  status                               String
  txCursor                             String?                         @map("tx_cursor")
  config                               Json?
  createdAt                            DateTime                        @default(now()) @map("created_at")
  updatedAt                            DateTime                        @updatedAt @map("updated_at")
  deletedAt                            DateTime?                       @map("deleted_at")
  accounts                             BankAccount[]
  secrets                              ConnectionSecret?
  sponsorHistory                       ConnectionSponsorHistory[]
  owner                                Profile                         @relation(fields: [ownerProfileId], references: [id], onDelete: Cascade)
  profileTransactionAccessCacheEntries ProfileTransactionAccessCache[]
  syncAuditLogs                        SyncAuditLog[]
  syncSessions                         SyncSession[]
  transactions                         Transaction[]
  userConnectionAccessCacheEntries     UserConnectionAccessCache[]
  workspaceLinks                       WorkspaceConnectionLink[]

  @@index([ownerProfileId])
  @@index([provider, providerItemId])
  @@map("connections")
}

model ConnectionSponsorHistory {
  id            String     @id @default(uuid()) @db.Uuid
  connectionId  String     @map("connection_id") @db.Uuid
  fromProfileId String?    @map("from_profile_id") @db.Uuid
  toProfileId   String     @map("to_profile_id") @db.Uuid
  changedAt     DateTime   @default(now()) @map("changed_at")
  connection    Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  fromProfile   Profile?   @relation("ConnectionSponsorFrom", fields: [fromProfileId], references: [id])
  toProfile     Profile    @relation("ConnectionSponsorTo", fields: [toProfileId], references: [id], onDelete: Cascade)

  @@index([connectionId])
  @@map("connection_sponsor_history")
}

model ConnectionSecret {
  id                       String     @id @default(uuid()) @db.Uuid
  connectionId             String     @unique @map("connection_id") @db.Uuid
  accessTokenCiphertext    String?    @map("access_token_ciphertext")
  processorTokenCiphertext String?    @map("processor_token_ciphertext")
  webhookSecretCiphertext  String?    @map("webhook_secret_ciphertext")
  createdAt                DateTime   @default(now()) @map("created_at")
  updatedAt                DateTime   @updatedAt @map("updated_at")
  connection               Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@map("connection_secrets")
}

model BankAccount {
  id                            String                          @id @default(uuid()) @db.Uuid
  connectionId                  String                          @map("connection_id") @db.Uuid
  externalAccountId             String                          @map("external_account_id")
  institution                   String?
  subtype                       String?
  mask                          String?
  name                          String?
  balanceCents                  BigInt?                         @map("balance_cents")
  currency                      String                          @db.VarChar(3)
  hidden                        Boolean                         @default(false)
  createdAt                     DateTime                        @default(now()) @map("created_at")
  updatedAt                     DateTime                        @updatedAt @map("updated_at")
  deletedAt                     DateTime?                       @map("deleted_at")
  accountGroupMemberships       AccountGroupMembership[]
  connection                    Connection                      @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  transactionAccessCacheEntries ProfileTransactionAccessCache[]
  transactions                  Transaction[]
  workspaceAllowedAccounts      WorkspaceAllowedAccount[]

  @@index([connectionId])
  @@map("bank_accounts")
}

model Transaction {
  id                                   String                          @id @default(uuid()) @db.Uuid
  accountId                            String                          @map("account_id") @db.Uuid
  connectionId                         String                          @map("connection_id") @db.Uuid
  providerTxId                         String                          @map("provider_tx_id")
  postedAt                             DateTime                        @map("posted_at")
  authorizedAt                         DateTime?                       @map("authorized_at")
  amountCents                          BigInt                          @map("amount_cents")
  currency                             String                          @db.VarChar(3)
  systemCategoryId                     String?                         @map("system_category_id") @db.Uuid
  merchantRaw                          String?                         @map("merchant_raw")
  rawPayload                           Json?                           @map("raw_payload")
  createdAt                            DateTime                        @default(now()) @map("created_at")
  profileTransactionAccessCacheEntries ProfileTransactionAccessCache[]
  auditLogs                            TransactionAuditLog[]
  overlays                             TransactionOverlay[]
  account                              BankAccount                     @relation(fields: [accountId], references: [id], onDelete: Cascade)
  connection                           Connection                      @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  systemCategory                       Category?                       @relation("TransactionSystemCategory", fields: [systemCategoryId], references: [id])

  @@index([accountId])
  @@index([connectionId, providerTxId])
  @@index([postedAt])
  @@map("transactions")
}

model TransactionOverlay {
  id                 String      @id @default(uuid()) @db.Uuid
  transactionId      String      @map("transaction_id") @db.Uuid
  profileId          String      @map("profile_id") @db.Uuid
  categoryId         String?     @map("category_id") @db.Uuid
  notes              String?
  tags               String[]    @default([])
  splits             Json        @default("[]")
  merchantCorrection String?     @map("merchant_correction")
  exclude            Boolean     @default(false)
  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @updatedAt @map("updated_at")
  deletedAt          DateTime?   @map("deleted_at")
  category           Category?   @relation(fields: [categoryId], references: [id])
  profile            Profile     @relation(fields: [profileId], references: [id], onDelete: Cascade)
  transaction        Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([transactionId])
  @@map("transaction_overlays")
}

model TransactionAuditLog {
  id            String       @id @default(uuid()) @db.Uuid
  transactionId String       @map("transaction_id") @db.Uuid
  syncSessionId String?      @map("sync_session_id") @db.Uuid
  event         String
  details       Json?
  createdAt     DateTime     @default(now()) @map("created_at")
  syncSession   SyncSession? @relation(fields: [syncSessionId], references: [id])
  transaction   Transaction  @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([transactionId])
  @@map("transaction_audit_log")
}

model BudgetPlan {
  id                 String          @id @default(uuid()) @db.Uuid
  workspaceId        String          @map("workspace_id") @db.Uuid
  ownerProfileId     String          @map("owner_profile_id") @db.Uuid
  name               String?
  currency           String          @db.VarChar(3)
  rollupMode         String          @map("rollup_mode")
  viewId             String?         @map("view_id") @db.Uuid
  viewFilterSnapshot Json?           @map("view_filter_snapshot")
  viewFilterHash     String?         @map("view_filter_hash")
  isTemplate         Boolean         @default(false) @map("is_template")
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")
  deletedAt          DateTime?       @map("deleted_at")
  actuals            BudgetActual[]
  owner              Profile         @relation(fields: [ownerProfileId], references: [id], onDelete: Cascade)
  view               SavedView?      @relation(fields: [viewId], references: [id])
  workspace          Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  versions           BudgetVersion[]

  @@map("budget_plans")
}

model BudgetVersion {
  id            String           @id @default(uuid()) @db.Uuid
  planId        String           @map("plan_id") @db.Uuid
  versionNo     Int              @map("version_no")
  effectiveFrom DateTime         @map("effective_from")
  effectiveTo   DateTime?        @map("effective_to")
  period        String
  carryoverMode String           @map("carryover_mode")
  notes         String?
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  actuals       BudgetActual[]
  envelopes     BudgetEnvelope[]
  plan          BudgetPlan       @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, versionNo])
  @@map("budget_versions")
}

model BudgetEnvelope {
  id         String         @id @default(uuid()) @db.Uuid
  versionId  String         @map("version_id") @db.Uuid
  categoryId String?        @map("category_id") @db.Uuid
  label      String
  limitCents BigInt         @map("limit_cents")
  warnAtPct  Int?           @map("warn_at_pct")
  groupLabel String?        @map("group_label")
  metadata   Json?
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @updatedAt @map("updated_at")
  deletedAt  DateTime?      @map("deleted_at")
  actuals    BudgetActual[]
  category   Category?      @relation(fields: [categoryId], references: [id])
  version    BudgetVersion  @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@map("budget_envelopes")
}

model BudgetActual {
  planId                String             @map("plan_id") @db.Uuid
  versionId             String             @map("version_id") @db.Uuid
  envelopeId            String             @map("envelope_id") @db.Uuid
  workspaceId           String             @map("workspace_id") @db.Uuid
  period                DateTime           @map("period") @db.Date
  currency              String             @db.VarChar(3)
  rollupMode            String             @map("rollup_mode")
  postedAmountCents     BigInt             @map("posted_amount_cents")
  authorizedAmountCents BigInt             @map("authorized_amount_cents")
  workspaceCategoryId   String?            @map("workspace_category_id") @db.Uuid
  updatedAt             DateTime           @updatedAt @map("updated_at")
  envelope              BudgetEnvelope     @relation(fields: [envelopeId], references: [id], onDelete: Cascade)
  plan                  BudgetPlan         @relation(fields: [planId], references: [id], onDelete: Cascade)
  version               BudgetVersion      @relation(fields: [versionId], references: [id], onDelete: Cascade)
  workspaceCategory     WorkspaceCategory? @relation(fields: [workspaceCategoryId], references: [id])
  workspace             Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@id([planId, versionId, envelopeId, period])
  @@index([workspaceId, period])
  @@map("budget_actuals")
}

model SyncSession {
  id                   String                @id @default(uuid()) @db.Uuid
  connectionId         String                @map("connection_id") @db.Uuid
  initiatorProfileId   String                @map("initiator_profile_id") @db.Uuid
  status               String
  startedAt            DateTime?             @map("started_at")
  endedAt              DateTime?             @map("ended_at")
  stats                Json?
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  idempotencyRecords   SessionIdempotency[]
  leases               SessionLease[]
  pagePayloads         SessionPagePayload[]
  auditLog             SyncAuditLog[]
  connection           Connection            @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  initiator            Profile               @relation("SyncInitiator", fields: [initiatorProfileId], references: [id], onDelete: Cascade)
  transactionAuditLogs TransactionAuditLog[]

  @@index([connectionId])
  @@map("sync_sessions")
}

model SessionPagePayload {
  id            String      @id @default(uuid()) @db.Uuid
  syncSessionId String      @map("sync_session_id") @db.Uuid
  pageNo        Int         @map("page_no")
  payload       Json
  expiresAt     DateTime    @map("expires_at")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  session       SyncSession @relation(fields: [syncSessionId], references: [id], onDelete: Cascade)

  @@index([syncSessionId])
  @@index([expiresAt])
  @@map("session_page_payloads")
}

model SessionIdempotency {
  id             String      @id @default(uuid()) @db.Uuid
  syncSessionId  String      @map("sync_session_id") @db.Uuid
  idempotencyKey String      @unique @map("idempotency_key")
  status         String
  resultRef      String?     @map("result_ref")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  session        SyncSession @relation(fields: [syncSessionId], references: [id], onDelete: Cascade)

  @@index([syncSessionId])
  @@map("session_idempotency")
}

model SessionLease {
  id            String      @id @default(uuid()) @db.Uuid
  syncSessionId String      @map("sync_session_id") @db.Uuid
  leasedUntil   DateTime    @map("leased_until")
  holder        String
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  session       SyncSession @relation(fields: [syncSessionId], references: [id], onDelete: Cascade)

  @@index([syncSessionId])
  @@map("session_leases")
}

model SyncAuditLog {
  id                 String       @id @default(uuid()) @db.Uuid
  connectionId       String       @map("connection_id") @db.Uuid
  syncSessionId      String?      @map("sync_session_id") @db.Uuid
  initiatorProfileId String?      @map("initiator_profile_id") @db.Uuid
  event              String
  details            Json?
  createdAt          DateTime     @default(now()) @map("created_at")
  connection         Connection   @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  initiator          Profile?     @relation("SyncAuditInitiator", fields: [initiatorProfileId], references: [id])
  session            SyncSession? @relation(fields: [syncSessionId], references: [id])

  @@index([connectionId])
  @@map("sync_audit_log")
}

model UserConnectionAccessCache {
  id           String     @id @default(uuid()) @db.Uuid
  profileId    String     @map("profile_id") @db.Uuid
  connectionId String     @map("connection_id") @db.Uuid
  workspaceId  String?    @map("workspace_id") @db.Uuid
  accountScope Json?      @map("account_scope_json")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  profile      Profile    @relation(fields: [profileId], references: [id], onDelete: Cascade)
  workspace    Workspace? @relation(fields: [workspaceId], references: [id])

  @@index([profileId])
  @@index([connectionId])
  @@map("user_connection_access_cache")
}

model ProfileTransactionAccessCache {
  id            String       @id @default(uuid()) @db.Uuid
  transactionId String       @map("transaction_id") @db.Uuid
  profileId     String       @map("profile_id") @db.Uuid
  workspaceId   String?      @map("workspace_id") @db.Uuid
  connectionId  String?      @map("connection_id") @db.Uuid
  bankAccountId String?      @map("bank_account_id") @db.Uuid
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  bankAccount   BankAccount? @relation(fields: [bankAccountId], references: [id])
  connection    Connection?  @relation(fields: [connectionId], references: [id])
  profile       Profile      @relation(fields: [profileId], references: [id], onDelete: Cascade)
  transaction   Transaction  @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  workspace     Workspace?   @relation(fields: [workspaceId], references: [id])

  @@index([transactionId])
  @@index([profileId])
  @@map("profile_transaction_access_cache")
}

// =============================================================================
// ENUMS
// =============================================================================

enum UserState {
  active
  disabled
  locked
}

enum IdentityProvider {
  google
  github
  auth0
  local_password
  local_magic_link
}

enum WorkspaceType {
  personal
  shared
}

enum WorkspaceRole {
  owner
  admin
  member
  viewer
}

enum MfaLevel {
  none
  mfa
  phishing_resistant
}

enum VerificationTokenType {
  email_verification
  password_reset
  magic_link
  invite
}

enum ServiceType {
  internal
  external
}

enum OAuthClientType {
  public
  confidential
}

enum OAuthGrantType {
  authorization_code
  refresh_token
  client_credentials
  device_code
}

enum PkceChallengeMethod {
  S256
  plain
}

enum AuthMethod {
  none
  client_secret_post
  client_secret_basic
  private_key_jwt
}

enum ClientType {
  web
  mobile
  cli
  service
  other
}
